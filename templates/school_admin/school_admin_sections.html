{% extends 'school_admin/school_admin_base.html' %}
{% block title %}Sections | School Admin{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-xl p-10 mt-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-700 via-blue-600 to-blue-800 bg-clip-text text-transparent flex items-center gap-4">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-700 via-blue-600 to-blue-800 rounded-2xl flex items-center justify-center text-white shadow-xl">
                    <i class="fas fa-cubes text-2xl"></i>
                </div>
                Section Hub
            </h1>
            <p class="text-gray-600 text-lg ml-20">Modern classroom management and organization.</p>
        </div>
        <button onclick="openSectionModal()" class="bg-gradient-to-r from-blue-700 via-blue-600 to-blue-800 hover:from-blue-800 hover:via-blue-700 hover:to-blue-900 text-white px-8 py-4 rounded-2xl font-bold shadow-lg transition-all transform hover:scale-105 hover:shadow-xl flex items-center gap-3">
            <i class="fas fa-plus-circle text-xl"></i>
            <span>New Section</span>
        </button>
    </div>

    <!-- Section Grid -->
    <div id="sectionsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
</div>

<!-- Section Modal -->
<div id="sectionModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg relative overflow-hidden">
        <!-- Blue Gradient Background -->
        <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-blue-700 via-blue-600 to-blue-800 opacity-10"></div>
        
        <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl z-10" onclick="closeSectionModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="relative z-10">
            <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-700 via-blue-600 to-blue-800 bg-clip-text text-transparent mb-8 flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-700 via-blue-600 to-blue-800 rounded-xl flex items-center justify-center text-white">
                    <i class="fas fa-cube"></i>
                </div>
                Create Section
            </h2>
            
            <form onsubmit="saveSection(event)" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-3 text-lg">
                        <i class="fas fa-tag mr-2 text-blue-700"></i>Section Name
                    </label>
                    <input type="text" id="sectionName" class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-700 focus:border-transparent transition-all text-lg" placeholder="e.g., 7-A, Science Lab 1" required>
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-3 text-lg">
                        <i class="fas fa-layer-group mr-2 text-blue-700"></i>Grade Level
                    </label>
                    <select id="gradeLevel" class="w-full px-6 py-4 border-2 border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-700 focus:border-transparent transition-all text-lg" required>
                    <option value="">Select Grade Level</option>
                    <option value="Grade 7">Grade 7</option>
                    <option value="Grade 8">Grade 8</option>
                    <option value="Grade 9">Grade 9</option>
                    <option value="Grade 10">Grade 10</option>
                    <option value="Grade 11">Grade 11</option>
                    <option value="Grade 12">Grade 12</option>
                </select>
            </div>
                <div>
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-700 via-blue-600 to-blue-800 hover:from-blue-800 hover:via-blue-700 hover:to-blue-900 text-white py-4 rounded-2xl font-bold transition-all transform hover:scale-105 hover:shadow-xl flex items-center justify-center gap-3 text-lg">
                        <i class="fas fa-save"></i>
                        <span>Create Section</span>
                    </button>
                </div>
            </form>
            <p id="modalMessage" class="mt-4 text-center text-sm"></p>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", fetchSections);

async function fetchSections() {
    const container = document.getElementById('sectionsContainer');
    container.innerHTML = '<p class="text-gray-500 text-center col-span-3">Loading sections...</p>';
    try {
        const res = await fetch('/school_admin/api/sections');
        const data = await res.json();

        if (!data.success || !data.sections.length) {
            container.innerHTML = '<p class="text-gray-500 text-center col-span-3">No sections found.</p>';
            return;
        }

        container.innerHTML = data.sections.map(section => `
            <div class="group bg-white rounded-3xl shadow-lg hover:shadow-2xl border border-gray-100 overflow-hidden transition-all duration-300 hover:-translate-y-2" data-section-id="${section.id}">
                <!-- Section Header with Darker Blue Gradient -->
                <div class="relative bg-gradient-to-br from-blue-700 via-blue-600 to-blue-800 p-6 text-white">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white bg-opacity-10 rounded-full -translate-y-16 translate-x-16"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-white bg-opacity-10 rounded-full translate-y-12 -translate-x-12"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-14 h-14 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-white border-opacity-30">
                                    <i class="fas fa-cube text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold">${section.name}</h3>
                                    <p class="text-sm text-white text-opacity-80">${section.grade_level}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSection(${section.id}, '${section.name}', '${section.grade_level}')" class="w-10 h-10 bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 rounded-xl flex items-center justify-center transition-all">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteSection(${section.id})" class="w-10 h-10 bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 rounded-xl flex items-center justify-center transition-all">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Section Stats -->
                        <div class="flex items-center gap-4 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-users"></i>
                                <span>30 Students</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-clock"></i>
                                <span>8 Periods</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section Content -->
                <div class="p-6">
                    <!-- Activity Timeline -->
                    <div class="space-y-3 mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Today's Schedule</h4>
                        <div class="flex items-center gap-3 text-sm">
                            <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
                            <span class="text-gray-600">8:00 AM - Mathematics</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-gray-600">10:00 AM - Science</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm">
                            <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                            <span class="text-gray-400">2:00 PM - Free Period</span>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 gap-3">
                        <button class="bg-blue-50 hover:bg-blue-100 rounded-xl p-3 text-center transition-colors group">
                            <i class="fas fa-user-graduate text-blue-700 group-hover:text-blue-800 mb-1"></i>
                            <p class="text-xs text-blue-700 group-hover:text-blue-800">View Students</p>
                        </button>
                        <button class="bg-blue-50 hover:bg-blue-100 rounded-xl p-3 text-center transition-colors group">
                            <i class="fas fa-calendar-alt text-blue-600 group-hover:text-blue-700 mb-1"></i>
                            <p class="text-xs text-blue-600 group-hover:text-blue-700">Schedule</p>
                        </button>
                    </div>
                </div>
                
                <!-- Status Indicator -->
                <div class="absolute top-4 left-4">
                    <div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-sm animate-pulse"></div>
                </div>
            </div>
        `).join('');
    } catch (err) {
        console.error(err);
        container.innerHTML = '<p class="text-red-500 text-center col-span-3">Error loading sections.</p>';
    }
}

let editingSectionId = null;

function openSectionModal() {
    document.getElementById('sectionModal').classList.remove('hidden');
    document.getElementById('modalMessage').textContent = '';
}

function closeSectionModal() {
    document.getElementById('sectionModal').classList.add('hidden');
    document.getElementById('sectionName').value = '';
    document.getElementById('gradeLevel').value = '';
    editingSectionId = null;
}

function editSection(id, name, grade) {
    editingSectionId = id;
    openSectionModal();
    document.getElementById('sectionName').value = name;
    document.getElementById('gradeLevel').value = grade;
}

async function saveSection(event) {
    event.preventDefault();
    const name = document.getElementById('sectionName').value.trim();
    const grade_level = document.getElementById('gradeLevel').value.trim();
    const message = document.getElementById('modalMessage');

    if (!name || !grade_level) return;

    const url = editingSectionId
        ? `/school_admin/api/update/section/${editingSectionId}`
        : '/school_admin/api/create/section';
    const method = editingSectionId ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, grade_level })
        });
        const data = await res.json();

        message.textContent = data.message;
        message.className = data.success
            ? 'text-green-600 mt-3 text-center text-sm'
            : 'text-red-600 mt-3 text-center text-sm';

        if (data.success) {
            if (editingSectionId) {
                // Update existing section in the grid
                updateSectionInGrid(editingSectionId, { name, grade_level });
            } else {
                // Add new section to the grid
                addSectionToGrid(data.section);
            }
            
            setTimeout(() => {
                closeSectionModal();
            }, 1000);
        }
    } catch (err) {
        console.error(err);
        message.textContent = 'Error saving section.';
        message.className = 'text-red-600 mt-3 text-center text-sm';
    }
}

async function deleteSection(id) {
    if (!confirm('Are you sure you want to delete this section?')) return;
    try {
        const res = await fetch(`/school_admin/api/delete/section/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
            // Remove section from grid without refreshing
            removeSectionFromGrid(id);
        }
        
        // Show message with appropriate styling
        showMessage(data.message, data.success ? 'success' : 'error');
    } catch (err) {
        showMessage('Error deleting section.', 'error');
        console.error(err);
    }
}

// Helper function to add new section to grid
function addSectionToGrid(section) {
    const container = document.getElementById('sectionsContainer');
    
    // Check if container shows "No sections found" message
    if (container.innerHTML.includes('No sections found')) {
        container.innerHTML = '';
    }
    
    const sectionHTML = `
        <div class="group bg-white rounded-3xl shadow-lg hover:shadow-2xl border border-gray-100 overflow-hidden transition-all duration-300 hover:-translate-y-2" data-section-id="${section.id}">
            <!-- Section Header with Blue Gradient -->
            <div class="relative bg-gradient-to-br from-blue-500 via-sky-500 to-cyan-500 p-6 text-white">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white bg-opacity-10 rounded-full -translate-y-16 translate-x-16"></div>
                <div class="absolute bottom-0 left-0 w-24 h-24 bg-white bg-opacity-10 rounded-full translate-y-12 -translate-x-12"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-14 h-14 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center border border-white border-opacity-30">
                                <i class="fas fa-cube text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">${section.name}</h3>
                                <p class="text-sm text-white text-opacity-80">${section.grade_level}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editSection(${section.id}, '${section.name}', '${section.grade_level}')" class="w-10 h-10 bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 rounded-xl flex items-center justify-center transition-all">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSection(${section.id})" class="w-10 h-10 bg-white bg-opacity-20 backdrop-blur-sm hover:bg-opacity-30 rounded-xl flex items-center justify-center transition-all">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section Stats -->
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-users"></i>
                            <span>30 Students</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            <span>8 Periods</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section Content -->
            <div class="p-6">
                <!-- Activity Timeline -->
                <div class="space-y-3 mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Today's Schedule</h4>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <span class="text-gray-600">8:00 AM - Mathematics</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-3 h-3 bg-sky-400 rounded-full"></div>
                        <span class="text-gray-600">10:00 AM - Science</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <div class="w-3 h-3 bg-gray-300 rounded-full"></div>
                        <span class="text-gray-400">2:00 PM - Free Period</span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button class="bg-blue-50 hover:bg-blue-100 rounded-xl p-3 text-center transition-colors group">
                        <i class="fas fa-user-graduate text-blue-600 group-hover:text-blue-800 mb-1"></i>
                        <p class="text-xs text-blue-600 group-hover:text-blue-800">View Students</p>
                    </button>
                    <button class="bg-sky-50 hover:bg-sky-100 rounded-xl p-3 text-center transition-colors group">
                        <i class="fas fa-calendar-alt text-sky-600 group-hover:text-sky-800 mb-1"></i>
                        <p class="text-xs text-sky-600 group-hover:text-sky-800">Schedule</p>
                    </button>
                </div>
            </div>
            
            <!-- Status Indicator -->
            <div class="absolute top-4 left-4">
                <div class="w-4 h-4 bg-cyan-400 rounded-full border-2 border-white shadow-sm animate-pulse"></div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', sectionHTML);
    
    // Add a nice animation effect
    const newSection = container.lastElementChild;
    newSection.style.opacity = '0';
    newSection.style.transform = 'scale(0.9)';
    setTimeout(() => {
        newSection.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        newSection.style.opacity = '1';
        newSection.style.transform = 'scale(1)';
    }, 10);
}

// Helper function to update existing section in grid
function updateSectionInGrid(sectionId, sectionData) {
    const sectionElement = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (sectionElement) {
        const nameElement = sectionElement.querySelector('h2');
        const gradeElement = sectionElement.querySelector('p b');
        const editButton = sectionElement.querySelector('button[onclick*="editSection"]');
        
        nameElement.textContent = sectionData.name;
        gradeElement.textContent = sectionData.grade_level;
        editButton.setAttribute('onclick', `editSection(${sectionId}, '${sectionData.name}', '${sectionData.grade_level}')`);
        
        // Add a brief highlight effect
        sectionElement.style.transform = 'scale(1.02)';
        sectionElement.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.3)';
        setTimeout(() => {
            sectionElement.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
            sectionElement.style.transform = 'scale(1)';
            sectionElement.style.boxShadow = '';
        }, 300);
    }
}

// Helper function to remove section from grid
function removeSectionFromGrid(sectionId) {
    const sectionElement = document.querySelector(`[data-section-id="${sectionId}"]`);
    if (sectionElement) {
        sectionElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        sectionElement.style.opacity = '0';
        sectionElement.style.transform = 'scale(0.9)';
        setTimeout(() => {
            sectionElement.remove();
            
            // Check if grid is empty and show message
            const container = document.getElementById('sectionsContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center col-span-3">No sections found.</p>';
            }
        }, 300);
    }
}

// Helper function to show temporary messages
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // Slide in animation
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(0)';
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(messageDiv);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
