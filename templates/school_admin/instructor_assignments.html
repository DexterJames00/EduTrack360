{% extends 'school_admin/school_admin_base.html' %}
{% block title %}Instructor Assignments | School Admin{% endblock %}
{% block content %}

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-4">
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} bg-{{ 'red' if category in ['error', 'danger'] else 'green' if category == 'success' else 'blue' }}-100 border border-{{ 'red' if category in ['error', 'danger'] else 'green' if category == 'success' else 'blue' }}-400 text-{{ 'red' if category in ['error', 'danger'] else 'green' if category == 'success' else 'blue' }}-700 px-4 py-3 rounded mb-4">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl shadow-xl p-8 mt-6 border border-slate-200">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-800 to-blue-600 bg-clip-text text-transparent flex items-center gap-3">
            <i class="fa-solid fa-calendar-alt text-blue-700"></i> Instructor Assignments
        </h1>
        <button class="bg-gradient-to-r from-blue-700 to-blue-800 text-white px-6 py-3 rounded-xl font-bold hover:from-blue-800 hover:to-blue-900 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1" onclick="openAssignmentModal()">
            <i class="fa-solid fa-plus mr-2"></i> New Assignment
        </button>
    </div>
    <p class="text-slate-600 mb-8 text-lg">Assign subjects to instructors with specific sections, times, and days.</p>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
            <i class="fa-solid fa-clipboard-list text-3xl text-blue-600 mb-3"></i>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Total Assignments</h3>
            <p class="text-2xl font-extrabold text-blue-700">{{ assignments|length }}</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
            <i class="fa-solid fa-chalkboard-teacher text-3xl text-green-600 mb-3"></i>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Instructors</h3>
            <p class="text-2xl font-extrabold text-green-700">{{ instructors|length }}</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
            <i class="fa-solid fa-book text-3xl text-purple-600 mb-3"></i>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Subjects</h3>
            <p class="text-2xl font-extrabold text-purple-700">{{ subjects|length }}</p>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
            <i class="fa-solid fa-users text-3xl text-orange-600 mb-3"></i>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Sections</h3>
            <p class="text-2xl font-extrabold text-orange-700">{{ sections|length }}</p>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="flex justify-center mb-6">
        <div class="bg-white rounded-xl shadow-lg p-2 flex">
            <button id="listViewBtn" class="px-6 py-2 rounded-lg font-semibold transition-all bg-blue-600 text-white" onclick="toggleView('list')">
                <i class="fa-solid fa-list mr-2"></i>List View
            </button>
            <button id="scheduleViewBtn" class="px-6 py-2 rounded-lg font-semibold transition-all text-gray-600 hover:text-blue-600" onclick="toggleView('schedule')">
                <i class="fa-solid fa-calendar mr-2"></i>Schedule View
            </button>
        </div>
    </div>

    <!-- List View -->
    <div id="listView" class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-blue-700 text-white">
                    <tr>
                        <th class="py-4 px-6 text-left">Instructor</th>
                        <th class="py-4 px-6 text-left">Subject</th>
                        <th class="py-4 px-6 text-left">Section</th>
                        <th class="py-4 px-6 text-left">Day</th>
                        <th class="py-4 px-6 text-left">Time</th>
                        <th class="py-4 px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="assignmentsTableBody">
                    {% for assignment in assignments %}
                    <tr class="hover:bg-blue-50 transition" data-assignment-id="{{ assignment.id }}">
                        <td class="py-4 px-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fa-solid fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">{{ assignment.instructor_name }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            <div class="font-medium text-gray-800">{{ assignment.subject_name }}</div>
                            <div class="text-sm text-gray-500">Grade {{ assignment.subject_grade }}</div>
                        </td>
                        <td class="py-4 px-6">
                            <div class="font-medium text-gray-800">{{ assignment.section_name }}</div>
                            <div class="text-sm text-gray-500">Grade {{ assignment.section_grade }}</div>
                        </td>
                        <td class="py-4 px-6">
                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                {{ assignment.day }}
                            </span>
                        </td>
                        <td class="py-4 px-6">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                {{ assignment.start_time }} - {{ assignment.end_time }}
                            </span>
                        </td>
                        <td class="py-4 px-6 text-center">
                            <div class="flex justify-center space-x-2">
                                <button onclick="editAssignment({{ assignment.id }}, '{{ assignment.instructor_id }}', '{{ assignment.subject_id }}', '{{ assignment.section_id }}', '{{ assignment.start_time }}', '{{ assignment.end_time }}', '{{ assignment.day }}')"
                                        class="w-8 h-8 bg-blue-100 hover:bg-blue-200 rounded-lg flex items-center justify-center transition-all">
                                    <i class="fa-solid fa-edit text-blue-600 text-sm"></i>
                                </button>
                                <button onclick="deleteAssignment({{ assignment.id }}, '{{ assignment.instructor_name }}', '{{ assignment.subject_name }}')"
                                        class="w-8 h-8 bg-red-100 hover:bg-red-200 rounded-lg flex items-center justify-center transition-all">
                                    <i class="fa-solid fa-trash text-red-600 text-sm"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="py-12 text-center text-gray-500">
                            <i class="fa-solid fa-calendar-xmark text-4xl mb-4"></i>
                            <p class="text-lg">No assignments created yet</p>
                            <button onclick="openAssignmentModal()" class="inline-block mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                Create First Assignment
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Schedule View -->
    <div id="scheduleView" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-7 gap-4">
            {% for day in days %}
            <div class="bg-white rounded-xl shadow-lg p-4">
                <h3 class="text-lg font-bold text-blue-800 mb-4 text-center border-b border-blue-200 pb-2">
                    {{ day }}
                </h3>
                <div class="space-y-3">
                    {% if organized_assignments[day] %}
                        {% for assignment in organized_assignments[day] %}
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 border border-blue-200">
                            <div class="text-sm font-bold text-blue-700">{{ assignment.start_time }} - {{ assignment.end_time }}</div>
                            <div class="font-semibold text-gray-800 text-sm">{{ assignment.subject_name }}</div>
                            <div class="text-xs text-gray-600">{{ assignment.instructor_name }}</div>
                            <div class="text-xs text-gray-600">Section: {{ assignment.section_name }}</div>
                            <div class="flex space-x-1 mt-2">
                                <button onclick="editAssignment({{ assignment.id }}, '{{ assignment.instructor_id }}', '{{ assignment.subject_id }}', '{{ assignment.section_id }}', '{{ assignment.start_time }}', '{{ assignment.end_time }}', '{{ assignment.day }}')"
                                        class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition">
                                    Edit
                                </button>
                                <button onclick="deleteAssignment({{ assignment.id }}, '{{ assignment.instructor_name }}', '{{ assignment.subject_name }}')"
                                        class="text-xs bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700 transition">
                                    Delete
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <i class="fa-solid fa-calendar-xmark text-2xl mb-2"></i>
                            <p class="text-sm">No classes</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Assignment Modal -->
<div id="assignmentModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-4xl relative mx-4 max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="relative bg-gradient-to-r from-blue-700 to-blue-800 text-white p-8 -m-8 mb-8 rounded-t-3xl">
            <button class="absolute top-6 right-6 w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-xl flex items-center justify-center text-white text-xl transition-all z-10" onclick="closeAssignmentModal()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="relative z-10">
                <div class="flex items-center space-x-6">
                    <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center backdrop-blur-sm border border-white border-opacity-30">
                        <i id="modalIcon" class="fas fa-calendar-plus text-2xl"></i>
                    </div>
                    <div>
                        <h2 id="modalTitle" class="text-3xl font-bold mb-2">Create Assignment</h2>
                        <p class="text-blue-100 text-lg">Assign a subject to an instructor with specific schedule</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <form id="assignmentForm" class="space-y-8">
            <input type="hidden" id="assignmentId" name="assignment_id" value="">
            
            <!-- Assignment Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Instructor Selection -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        <i class="fa-solid fa-chalkboard-teacher text-blue-600 mr-2"></i>Instructor
                    </label>
                    <select name="instructor_id" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Instructor</option>
                        {% for instructor in instructors %}
                        <option value="{{ instructor.id }}">{{ instructor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Subject Selection -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        <i class="fa-solid fa-book text-blue-600 mr-2"></i>Subject
                    </label>
                    <select name="subject_id" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }} (Grade {{ subject.grade_level }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Section Selection -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        <i class="fa-solid fa-users text-blue-600 mr-2"></i>Section
                    </label>
                    <select name="section_id" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Section</option>
                        {% for section in sections %}
                        <option value="{{ section.id }}">{{ section.name }} (Grade {{ section.grade_level }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Day Selection -->
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        <i class="fa-solid fa-calendar text-blue-600 mr-2"></i>Day
                    </label>
                    <select name="day" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Day</option>
                        {% for day in days %}
                        <option value="{{ day }}">{{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Time Input -->
                <div class="space-y-2 md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700">
                        <i class="fa-solid fa-clock text-blue-600 mr-2"></i>Time
                    </label>
                    <input type="time" name="time" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                <button type="button" onclick="closeAssignmentModal()" class="px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all">
                    Cancel
                </button>
                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-blue-700 to-blue-800 hover:from-blue-800 hover:to-blue-900 text-white rounded-xl font-bold shadow-lg transition-all flex items-center space-x-3">
                    <i class="fas fa-save"></i>
                    <span>Save Assignment</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md relative mx-4">
        <h3 class="text-2xl font-bold text-red-600 mb-4 flex items-center gap-3">
            <i class="fa-solid fa-exclamation-triangle"></i> Confirm Delete
        </h3>
        <p class="text-slate-600 mb-6">Are you sure you want to delete the assignment for <strong id="deleteAssignmentInfo"></strong>? This action cannot be undone.</p>
        <div class="flex gap-4">
            <button onclick="closeDeleteModal()" class="flex-1 bg-slate-300 text-slate-700 py-3 rounded-xl font-semibold hover:bg-slate-400 transition-colors duration-200">
                Cancel
            </button>
            <form id="deleteForm" class="flex-1">
                <button type="submit" class="w-full bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700 transition-colors duration-200">
                    Delete
                </button>
            </form>
        </div>
    </div>
</div>

<script>
let isEditMode = false;
let currentAssignmentId = null;

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Assignment form submission
    document.getElementById('assignmentForm').addEventListener('submit', handleAssignmentSubmit);
    
    // Delete form submission
    document.getElementById('deleteForm').addEventListener('submit', handleDeleteSubmit);
});

function toggleView(view) {
    const listView = document.getElementById('listView');
    const scheduleView = document.getElementById('scheduleView');
    const listBtn = document.getElementById('listViewBtn');
    const scheduleBtn = document.getElementById('scheduleViewBtn');
    
    if (view === 'list') {
        listView.classList.remove('hidden');
        scheduleView.classList.add('hidden');
        listBtn.classList.add('bg-blue-600', 'text-white');
        listBtn.classList.remove('text-gray-600');
        scheduleBtn.classList.remove('bg-blue-600', 'text-white');
        scheduleBtn.classList.add('text-gray-600');
    } else {
        listView.classList.add('hidden');
        scheduleView.classList.remove('hidden');
        scheduleBtn.classList.add('bg-blue-600', 'text-white');
        scheduleBtn.classList.remove('text-gray-600');
        listBtn.classList.remove('bg-blue-600', 'text-white');
        listBtn.classList.add('text-gray-600');
    }
}

function openAssignmentModal() {
    const modal = document.getElementById('assignmentModal');
    const title = document.getElementById('modalTitle');
    
    // Add mode
    isEditMode = false;
    currentAssignmentId = null;
    title.textContent = 'Create Assignment';
    
    // Clear form fields
    document.getElementById('assignmentForm').reset();
    document.querySelector('[name=assignment_id]').value = '';
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function editAssignment(id, instructorId, subjectId, sectionId, time, day) {
    const modal = document.getElementById('assignmentModal');
    const title = document.getElementById('modalTitle');
    
    // Edit mode
    isEditMode = true;
    currentAssignmentId = id;
    title.textContent = 'Edit Assignment';
    
    // Set the hidden assignment_id field
    document.querySelector('[name=assignment_id]').value = id;
    
    // Populate form fields
    document.querySelector('[name=instructor_id]').value = instructorId;
    document.querySelector('[name=subject_id]').value = subjectId;
    document.querySelector('[name=section_id]').value = sectionId;
    document.querySelector('[name=time]').value = time;
    document.querySelector('[name=day]').value = day;
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeAssignmentModal() {
    const modal = document.getElementById('assignmentModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function deleteAssignment(assignmentId, instructorName, subjectName) {
    const modal = document.getElementById('deleteModal');
    const infoElement = document.getElementById('deleteAssignmentInfo');
    
    currentAssignmentId = assignmentId;
    infoElement.textContent = `${instructorName} - ${subjectName}`;
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    currentAssignmentId = null;
}

// AJAX form submission for assignment
function handleAssignmentSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Client-side validation
    const instructorId = form.querySelector('[name="instructor_id"]').value;
    const subjectId = form.querySelector('[name="subject_id"]').value;
    const sectionId = form.querySelector('[name="section_id"]').value;
    const time = form.querySelector('[name="time"]').value;
    const day = form.querySelector('[name="day"]').value;
    
    // Validate required fields
    if (!instructorId || !subjectId || !sectionId || !time || !day) {
        showAlert('Please fill in all required fields.', 'error');
        return;
    }
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    submitBtn.disabled = true;
    
    const url = isEditMode ? 
        `/school_admin/assignments/update/${currentAssignmentId}` :
        `/school_admin/assignments/create`;
    
    const method = isEditMode ? 'PUT' : 'POST';
    
    // Convert FormData to JSON
    const data = Object.fromEntries(formData.entries());
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            closeAssignmentModal();
            
            // Reload the page to update the assignment list
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while saving the assignment.', 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// AJAX form submission for delete
function handleDeleteSubmit(e) {
    e.preventDefault();
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    submitBtn.disabled = true;
    
    const url = `/school_admin/assignments/delete/${currentAssignmentId}`;
    
    fetch(url, {
        method: 'DELETE',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            closeDeleteModal();
            
            // Remove the assignment row
            const row = document.querySelector(`[data-assignment-id="${currentAssignmentId}"]`);
            if (row) {
                row.remove();
            }
            
            // Reload the page to update both views
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while deleting the assignment.', 'error');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Alert system
function showAlert(message, type) {
    const alertContainer = document.querySelector('.mt-4') || createAlertContainer();
    
    const alertClass = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
    
    const alert = document.createElement('div');
    alert.className = `alert bg-${alertClass}-100 border border-${alertClass}-400 text-${alertClass}-700 px-4 py-3 rounded mb-4 opacity-0 transform translate-y-2 transition-all duration-300`;
    alert.textContent = message;
    
    alertContainer.appendChild(alert);
    
    // Trigger animation
    setTimeout(() => {
        alert.classList.remove('opacity-0', 'translate-y-2');
    }, 100);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alert.classList.add('opacity-0', 'translate-y-2');
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 300);
    }, 5000);
}

function createAlertContainer() {
    const container = document.createElement('div');
    container.className = 'mt-4';
    
    const mainContent = document.querySelector('.bg-gradient-to-br');
    mainContent.parentNode.insertBefore(container, mainContent);
    
    return container;
}

// Close modals when clicking outside
document.getElementById('assignmentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAssignmentModal();
    }
});

document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Close modals on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAssignmentModal();
        closeDeleteModal();
    }
});
</script>

{% endblock %}