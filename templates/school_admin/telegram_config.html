{% extends 'school_admin/school_admin_base.html' %}
{% block title %}Telegram Notifications | School Admin{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg p-10 mt-6">
    <h1 class="text-3xl font-extrabold text-blue-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-paper-plane"></i> Telegram Notifications
    </h1>
    <p class="text-gray-600 mb-8 text-lg">View and manage Telegram notifications for your school students.</p>
    
    <!-- School Bot Status -->
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-school"></i> Your School's Bot Status
                </h3>
                <p id="auto-setup-status" class="text-xl font-bold">Checking...</p>
                <p id="bot-system-status" class="text-sm opacity-90">Bot System: Loading...</p>
                <p class="text-sm opacity-90 mt-1">
                    <i class="fa-solid fa-info-circle mr-1"></i>
                    Connected to global bot system with school code: <span id="school-code-display" class="font-bold">{{ session.school_code or 'Loading...' }}</span>
                </p>
            </div>
            <div class="text-right">
                <button onclick="checkAutoSetupStatus()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition duration-200">
                    <i class="fa-solid fa-refresh mr-2"></i>Refresh Status
                </button>
            </div>
        </div>
    </div>
    
    <!-- Your School Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Total Students</h3>
                    <p class="text-3xl font-bold" id="total-students">0</p>
                    <p class="text-sm opacity-80">In your school</p>
                </div>
                <i class="fa-solid fa-graduation-cap text-4xl opacity-70"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Connected Parents</h3>
                    <p class="text-3xl font-bold" id="connected-parents">0</p>
                    <p class="text-sm opacity-80">Using Telegram</p>
                </div>
                <i class="fa-solid fa-link text-4xl opacity-70"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Not Connected</h3>
                    <p class="text-3xl font-bold" id="not-connected">0</p>
                    <p class="text-sm opacity-80">Need registration</p>
                </div>
                <i class="fa-solid fa-unlink text-4xl opacity-70"></i>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Connection Rate</h3>
                    <p class="text-3xl font-bold" id="connection-rate">0%</p>
                    <p class="text-sm opacity-80">School progress</p>
                </div>
                <i class="fa-solid fa-chart-pie text-4xl opacity-70"></i>
            </div>
        </div>
    </div>

    <!-- Registration Instructions -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-8">
        <h2 class="font-semibold text-xl mb-4 flex items-center gap-2 text-yellow-800">
            <i class="fa-solid fa-lightbulb"></i> How Parents Register for Notifications
        </h2>
        <div class="bg-yellow-100 p-4 rounded-lg mb-4">
            <h4 class="font-semibold text-yellow-800 mb-2">
                <i class="fa-solid fa-info-circle mr-2"></i>Registration Format
            </h4>
            <p class="text-sm text-yellow-700 mb-2">
                Parents need to send this message to the bot: 
                <code class="bg-white px-2 py-1 rounded font-mono">{{ session.school_code or 'SCHOOLCODE' }} STUDENTCODE</code>
            </p>
            <p class="text-sm text-yellow-700">
                Example: <code class="bg-white px-2 py-1 rounded font-mono">{{ session.school_code or 'ACLCCOLLEG' }} ABC123</code>
            </p>
        </div>
        <div class="text-sm text-yellow-700">
            <p><strong>Instructions for parents:</strong></p>
            <ol class="list-decimal ml-5 mt-2 space-y-1">
                <li>Find the school's official Telegram bot</li>
                <li>Start a chat with the bot</li>
                <li>Send the message: <strong>{{ session.school_code or 'SCHOOLCODE' }} [Student's Code]</strong></li>
                <li>Wait for confirmation message</li>
                <li>They will receive attendance notifications automatically</li>
            </ol>
        </div>
    </div>

    <!-- Your Students Connection Status -->
    <div class="bg-white border rounded-xl p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="font-semibold text-xl flex items-center gap-2">
                <i class="fa-solid fa-users"></i> Your Students' Connection Status
            </h2>
            <div class="flex gap-2">
                <button onclick="refreshData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                    <i class="fa-solid fa-refresh mr-2"></i>Refresh
                </button>
                <button onclick="exportData()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                    <i class="fa-solid fa-download mr-2"></i>Export
                </button>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="mb-4 flex gap-4 flex-wrap">
            <select id="connection-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Students</option>
                <option value="connected">Connected Only</option>
                <option value="not-connected">Not Connected Only</option>
            </select>
            <select id="grade-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Grades</option>
            </select>
            <input type="text" id="search-filter" placeholder="Search student name..." 
                   class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse border border-gray-300">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-4 py-3 text-left">Student Name</th>
                        <th class="border px-4 py-3 text-center">Student Code</th>
                        <th class="border px-4 py-3 text-center">Grade Level</th>
                        <th class="border px-4 py-3 text-center">Section</th>
                        <th class="border px-4 py-3 text-center">Parent Contact</th>
                        <th class="border px-4 py-3 text-center">Telegram Status</th>
                        <th class="border px-4 py-3 text-center">Registration Code</th>
                        <th class="border px-4 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="students-table">
                    <!-- Student data will be dynamically loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    let allStudents = [];
    let allGrades = [];
    let schoolCode = '{{ session.school_code or "" }}';

    // Load dashboard data
    async function loadDashboardData() {
        await Promise.all([
            loadStudentConnections(),
            loadStatistics()
        ]);
    }

    // Load school statistics
    async function loadStatistics() {
        try {
            const res = await fetch('/school_admin/telegram-stats');
            const stats = await res.json();
            
            document.getElementById('total-students').textContent = stats.total_students || 0;
            document.getElementById('connected-parents').textContent = stats.connected_parents || 0;
            document.getElementById('not-connected').textContent = stats.not_connected || 0;
            
            const connectionRate = stats.total_students > 0 
                ? Math.round((stats.connected_parents / stats.total_students) * 100) 
                : 0;
            document.getElementById('connection-rate').textContent = connectionRate + '%';
            
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    // Load student connections for this school only
    async function loadStudentConnections() {
        try {
            const res = await fetch('/school_admin/student-connections');
            const data = await res.json();
            allStudents = data.students || [];
            allGrades = [...new Set(allStudents.map(s => s.grade_level))];
            
            populateFilterDropdowns();
            displayStudents(allStudents);
            
        } catch (error) {
            console.error('Error loading student connections:', error);
            document.getElementById('students-table').innerHTML = 
                '<tr><td colspan="8" class="border px-4 py-2 text-red-500 text-center">Error loading student data</td></tr>';
        }
    }

    // Populate filter dropdowns
    function populateFilterDropdowns() {
        const gradeFilter = document.getElementById('grade-filter');
        
        // Populate grades
        gradeFilter.innerHTML = '<option value="all">All Grades</option>';
        allGrades.forEach(grade => {
            gradeFilter.innerHTML += `<option value="${grade}">${grade}</option>`;
        });
    }

    // Display students in table
    function displayStudents(students) {
        const tbody = document.getElementById('students-table');
        tbody.innerHTML = '';
        
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="border px-4 py-2 text-gray-500 text-center">No students found</td></tr>';
            return;
        }
        
        students.forEach(student => {
            const isConnected = student.telegram_status;
            const statusBadge = isConnected 
                ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold"><i class="fa-solid fa-check mr-1"></i>Connected</span>'
                : '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold"><i class="fa-solid fa-times mr-1"></i>Not Connected</span>';
            
            const registrationCode = `${schoolCode} ${student.code}`;
            
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="border px-4 py-3 font-medium">${student.first_name} ${student.last_name}</td>
                    <td class="border px-4 py-3 text-center"><code class="bg-gray-100 px-2 py-1 rounded">${student.code}</code></td>
                    <td class="border px-4 py-3 text-center">${student.grade_level}</td>
                    <td class="border px-4 py-3 text-center">${student.section_name || 'N/A'}</td>
                    <td class="border px-4 py-3 text-center">${student.parent_contact || 'N/A'}</td>
                    <td class="border px-4 py-3 text-center">${statusBadge}</td>
                    <td class="border px-4 py-3 text-center">
                        <code class="bg-blue-50 text-blue-800 px-2 py-1 rounded font-mono text-sm">${registrationCode}</code>
                    </td>
                    <td class="border px-4 py-3 text-center">
                        <div class="flex justify-center gap-1">
                            ${isConnected 
                                ? '<button onclick="sendTestMessage(' + student.id + ')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" title="Send Test Message"><i class="fa-solid fa-paper-plane"></i></button>'
                                : `<button onclick="showRegistrationHelp('${registrationCode}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600" title="Show Registration Help"><i class="fa-solid fa-info"></i></button>`
                            }
                            <button onclick="copyRegistrationCode('${registrationCode}')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600" title="Copy Registration Code"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    // Filter students
    function filterStudents() {
        const connectionFilter = document.getElementById('connection-filter').value;
        const gradeFilter = document.getElementById('grade-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();
        
        let filtered = allStudents;
        
        // Filter by connection status
        if (connectionFilter === 'connected') {
            filtered = filtered.filter(s => s.telegram_status);
        } else if (connectionFilter === 'not-connected') {
            filtered = filtered.filter(s => !s.telegram_status);
        }
        
        // Filter by grade
        if (gradeFilter !== 'all') {
            filtered = filtered.filter(s => s.grade_level === gradeFilter);
        }
        
        // Filter by search
        if (searchFilter) {
            filtered = filtered.filter(s => 
                (s.first_name + ' ' + s.last_name).toLowerCase().includes(searchFilter)
            );
        }
        
        displayStudents(filtered);
    }

    // Event listeners for filters
    document.getElementById('connection-filter').addEventListener('change', filterStudents);
    document.getElementById('grade-filter').addEventListener('change', filterStudents);
    document.getElementById('search-filter').addEventListener('input', filterStudents);

    // Utility functions
    function refreshData() {
        loadDashboardData();
    }

    function exportData() {
        // Implement export functionality
        alert('Export functionality coming soon!');
    }

    function sendTestMessage(studentId) {
        // Implement test message functionality
        alert(`Sending test message to student ID: ${studentId}`);
    }

    function showRegistrationHelp(registrationCode) {
        // Show registration instructions for the specific student
        const message = `To register for Telegram notifications, send this exact message to the school's bot:\n\n${registrationCode}\n\nMake sure to type it exactly as shown (including the space).`;
        alert(message);
    }

    function copyRegistrationCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert('Registration code copied to clipboard!');
        }).catch(() => {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Registration code copied to clipboard!');
        });
    }

    // Load all data on page load
    loadDashboardData();
    
    // Check auto-setup status on page load
    checkAutoSetupStatus();
    
    // Auto-refresh auto-setup status every 30 seconds
    setInterval(checkAutoSetupStatus, 30000);
    
    // Check auto-setup status
    async function checkAutoSetupStatus() {
        try {
            const response = await fetch('/school_admin/auto-setup-status');
            const data = await response.json();
            
            const statusElement = document.getElementById('auto-setup-status');
            const botSystemElement = document.getElementById('bot-system-status');
            
            if (data.setup_complete) {
                statusElement.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>Bot Connected';
                botSystemElement.textContent = 'Bot System: Active and Ready';
            } else {
                statusElement.innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-2"></i>Bot Not Ready';
                botSystemElement.textContent = 'Bot System: Setting up...';
            }
            
        } catch (error) {
            console.error('Error checking auto-setup status:', error);
            document.getElementById('auto-setup-status').innerHTML = '<i class="fa-solid fa-exclamation-triangle mr-2"></i>Bot system not available';
            document.getElementById('bot-system-status').textContent = 'Bot System: Not available';
        }
    }
</script>
{% endblock %}
{% endblock %}