{% extends 'instructor/base.html' %}
{% block title %}Record Attendance{% endblock %}
{% block content %}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-wrap justify-between items-center mb-6">
            <div>
                <h1 class="text-4xl font-extrabold text-blue-800 flex items-center gap-3">
                    <i class="fa-solid fa-clipboard-check text-blue-600"></i> Record Attendance
                </h1>
                {% if schedule %}
                <div class="mt-2 text-gray-700 space-y-1">
                    <p class="text-lg font-semibold text-blue-700">{{ schedule.subject }}</p>
                    <p class="text-sm text-gray-600">Section: {{ schedule.section }}</p>
                    <p class="text-sm text-gray-500">Scheduled: {{ schedule.start_time }} - {{ schedule.end_time }}</p>
                </div>
                {% endif %}
            </div>
            <div class="text-right">
                <div id="liveTime" class="text-3xl font-mono font-bold text-blue-700"></div>
                <div class="text-sm text-gray-500">Live Time</div>
            </div>
        </div>

        <!-- Form -->
        <form id="attendanceForm" method="POST" class="bg-white rounded-2xl shadow-lg p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Date -->
                <div>
                    <label for="date" class="block text-gray-700 font-semibold mb-2">Date</label>
                    <input type="date" id="date" name="date"
                        class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required>
                </div>
                <!-- Subject -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Subject</label>
                    <input type="text" value="{{ schedule.subject if schedule else 'N/A' }}" disabled
                        class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
                </div>
                <!-- Section -->
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Section</label>
                    <input type="text" value="{{ schedule.section if schedule else 'N/A' }}" disabled
                        class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-700">
                </div>
            </div>

            <!-- Students Table -->
            <div class="overflow-x-auto">
                <table class="w-full border border-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-blue-700 text-white">
                        <tr>
                            <th class="py-3 px-4 text-left">#</th>
                            <th class="py-3 px-4 text-left">Student Name</th>
                            <th class="py-3 px-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        {% for student in students %}
                        <tr class="hover:bg-blue-50 transition">
                            <td class="py-3 px-4">{{ loop.index }}</td>
                            <td class="py-3 px-4 font-medium">{{ student.name }}</td>
                            <td class="py-3 px-4 text-center">
                                                            <div class="flex items-center justify-center gap-2">
                                                                <select name="status_{{ student.id }}"
                                                                    class="px-3 py-2 rounded-md border border-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                                    <option value="Present">Present</option>
                                                                    <option value="Absent">Absent</option>
                                                                    <option value="Late">Late</option>
                                                                    <option value="Excused">Excused</option>
                                                                </select>
                                                                <button type="button" class="bg-blue-700 text-white px-3 py-1 rounded hover:bg-blue-800 transition text-xs" style="white-space:nowrap;" onclick="openMessageModal('{{ student.id }}', '{{ student.name }}')"><i class="fa-solid fa-envelope"></i> Send Message</button>
                                                            </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-8 text-right">
                <button type="submit" id="submitBtn"
                    class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="submitText">
                        <i class="fa-solid fa-paper-plane mr-2"></i> Submit Attendance
                    </span>
                    <span id="loadingText" class="hidden">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> Submitting...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
        <div class="text-center">
            <!-- Success Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <i class="fa-solid fa-check text-green-600 text-2xl"></i>
            </div>
            
            <!-- Success Message -->
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Attendance Submitted!</h3>
            <p id="successMessage" class="text-gray-600 mb-6">
                Attendance has been recorded successfully.
            </p>
            
            <!-- Notification Info -->
            <div id="notificationInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-center mb-2">
                    <i class="fa-brands fa-telegram text-blue-500 text-lg mr-2"></i>
                    <span class="text-blue-700 font-semibold">Telegram Notifications</span>
                </div>
                <div id="notificationDetails" class="text-blue-600 text-sm space-y-1">
                    <p id="notificationText">Sending notifications to students...</p>
                </div>
            </div>
            
            <!-- Students Without Telegram Info -->
            <div id="studentsWithoutTelegram" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex items-center justify-center mb-2">
                    <i class="fa-solid fa-exclamation-triangle text-yellow-500 text-lg mr-2"></i>
                    <span class="text-yellow-700 font-semibold">Students Without Telegram</span>
                </div>
                <div id="studentsWithoutTelegramDetails" class="text-yellow-600 text-sm">
                    <p id="studentsWithoutTelegramText">Some students haven't registered for Telegram notifications.</p>
                    <div id="studentsWithoutTelegramList" class="mt-2 text-xs bg-yellow-100 rounded p-2 hidden"></div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="goToSchedules()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-calendar mr-2"></i> Back to Schedules
                </button>
                <button onclick="recordAnother()" 
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-plus mr-2"></i> Record Another
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
        <div class="text-center">
            <!-- Error Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                <i class="fa-solid fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            
            <!-- Error Message -->
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Submission Failed</h3>
            <p id="errorMessage" class="text-gray-600 mb-6">
                An error occurred while submitting attendance.
            </p>
            
            <!-- Error Details -->
            <div id="errorDetails" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex items-center justify-center mb-2">
                    <i class="fa-solid fa-info-circle text-red-500 text-lg mr-2"></i>
                    <span class="text-red-700 font-semibold">Error Details</span>
                </div>
                <p id="errorDetailsText" class="text-red-600 text-sm">
                    Additional error information...
                </p>
            </div>
            
            <!-- Error Type Specific Content -->
            <div id="duplicateErrorContent" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex items-center justify-center mb-2">
                    <i class="fa-solid fa-calendar-times text-yellow-500 text-lg mr-2"></i>
                    <span class="text-yellow-700 font-semibold">Duplicate Attendance</span>
                </div>
                <p class="text-yellow-600 text-sm mb-3">
                    Attendance has already been recorded for this date.
                </p>
                <button onclick="suggestNewDate()" 
                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition text-sm">
                    <i class="fa-solid fa-calendar-plus mr-1"></i> Use Today's Date
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="closeErrorModal()" 
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-times mr-2"></i> Close
                </button>
                <button onclick="retrySubmission()" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-redo mr-2"></i> Try Again
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Message Modal -->
<div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 transform transition-all duration-300 scale-95">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-blue-800 flex items-center gap-3">
                <i class="fa-solid fa-envelope text-blue-600"></i> 
                Send Message to Parent
            </h2>
            <button class="text-gray-400 hover:text-gray-600 transition-colors" onclick="closeMessageModal()">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="messageForm" onsubmit="sendMessage(event)">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">
                    <i class="fa-solid fa-user text-blue-600 mr-1"></i> Student
                </label>
                <input type="text" id="modalStudentName" 
                    class="w-full px-4 py-3 border border-blue-300 rounded-lg bg-gray-50 text-gray-700 font-medium" readonly>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">
                    <i class="fa-solid fa-book text-blue-600 mr-1"></i> Subject
                </label>
                <input type="text" id="modalSubjectName" value="{{ schedule.subject if schedule else 'N/A' }}" 
                    class="w-full px-4 py-3 border border-blue-300 rounded-lg bg-gray-50 text-gray-700 font-medium" readonly>
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">
                    <i class="fa-solid fa-comment-dots text-blue-600 mr-1"></i> Message
                </label>
                <textarea id="modalMessage" 
                    class="w-full px-4 py-3 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" 
                    rows="4" 
                    placeholder="Type your message here..." 
                    required>Dear Parent, your child is a candidate for dropping due to attendance issues.</textarea>
                
                <!-- Quick Message Templates -->
                <div class="mt-3">
                    <p class="text-sm text-gray-600 mb-2">Quick templates:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="setMessageTemplate('dropping')" 
                            class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 text-xs rounded-full transition">
                            Dropping Candidate
                        </button>
                        <button type="button" onclick="setMessageTemplate('warning')" 
                            class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 text-xs rounded-full transition">
                            Attendance Warning
                        </button>
                        <button type="button" onclick="setMessageTemplate('improvement')" 
                            class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs rounded-full transition">
                            Needs Improvement
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="closeMessageModal()" 
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-times mr-2"></i> Cancel
                </button>
                <button type="submit" id="sendMessageBtn"
                    class="flex-1 bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg disabled:opacity-50">
                    <span id="sendMessageText">
                        <i class="fa-solid fa-paper-plane mr-2"></i> Send Message
                    </span>
                    <span id="sendingMessageText" class="hidden">
                        <i class="fa-solid fa-spinner fa-spin mr-2"></i> Sending...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Message Success Modal -->
<div id="messageSuccessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
        <div class="text-center">
            <!-- Success Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
                <i class="fa-solid fa-check text-green-600 text-2xl"></i>
            </div>
            
            <!-- Success Message -->
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Message Sent Successfully!</h3>
            <p id="messageSuccessText" class="text-gray-600 mb-4">
                Your message has been sent to the parent via Telegram.
            </p>
            
            <!-- Message Details -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">
                            <i class="fa-solid fa-user text-blue-500 mr-2"></i>Student:
                        </span>
                        <span id="successStudentName" class="font-semibold text-gray-800"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">
                            <i class="fa-solid fa-book text-blue-500 mr-2"></i>Subject:
                        </span>
                        <span id="successSubjectName" class="font-semibold text-gray-800"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">
                            <i class="fa-solid fa-clock text-blue-500 mr-2"></i>Sent:
                        </span>
                        <span id="successSentTime" class="font-semibold text-gray-800"></span>
                    </div>
                </div>
            </div>
            
            <!-- Action Button -->
            <button onclick="closeMessageSuccessModal()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition">
                <i class="fa-solid fa-check mr-2"></i> Great!
            </button>
        </div>
    </div>
</div>

<!-- Message Error Modal -->
<div id="messageErrorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
        <div class="text-center">
            <!-- Error Icon -->
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                <i class="fa-solid fa-exclamation-triangle text-red-600 text-2xl"></i>
            </div>
            
            <!-- Error Message -->
            <h3 class="text-2xl font-bold text-gray-900 mb-2">Message Failed</h3>
            <p id="messageErrorText" class="text-gray-600 mb-4">
                There was an error sending your message.
            </p>
            
            <!-- Error Details -->
            <div id="messageErrorDetails" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <div class="space-y-2 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600">
                            <i class="fa-solid fa-user text-red-500 mr-2"></i>Student:
                        </span>
                        <span id="errorStudentName" class="font-semibold text-gray-800"></span>
                    </div>
                    <div class="mt-3 p-3 bg-red-100 rounded text-red-700 text-xs">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        <span id="messageErrorDetailsText">Error details will appear here</span>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="closeMessageErrorModal()" 
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-times mr-2"></i> Close
                </button>
                <button onclick="retryMessage()" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition">
                    <i class="fa-solid fa-redo mr-2"></i> Try Again
                </button>
            </div>
        </div>
    </div>
</div>
<script>
// Attendance Form Submission
document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingText = document.getElementById('loadingText');
    
    // Show loading state
    submitBtn.disabled = true;
    submitText.classList.add('hidden');
    loadingText.classList.remove('hidden');
    
    // Collect form data
    const formData = new FormData(this);
    
    // Debug: Log form data
    console.log('Form data being sent:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Submit attendance
    fetch(window.location.href + '?ajax=1', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        console.log('Response URL:', response.url);
        
        if (!response.ok) {
            // Try to get error details from the response
            return response.json().then(errorData => {
                throw {
                    message: errorData.error || `HTTP error! status: ${response.status}`,
                    data: errorData,
                    status: response.status
                };
            }).catch(jsonError => {
                // If JSON parsing fails, create a basic error object
                if (jsonError.message) {
                    throw jsonError; // Re-throw if it's our custom error
                }
                throw {
                    message: `HTTP error! status: ${response.status}`,
                    data: {},
                    status: response.status
                };
            });
        }
        
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            // If we get HTML back, it means the server didn't recognize this as AJAX
            throw new Error('Server returned HTML instead of JSON. Please refresh and try again.');
        }
    })
    .then(data => {
        console.log('Success data:', data);
        if (data.success) {
            showSuccessModal(data);
        } else {
            showErrorModal(data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Handle different error types
        let errorData = {
            error: 'An unexpected error occurred',
            type: 'unknown'
        };
        
        if (error.data) {
            // Server returned structured error data
            errorData = {
                error: error.message,
                duplicate: error.data.duplicate || false,
                existing_date: error.data.existing_date || null,
                type: error.data.duplicate ? 'duplicate' : 'server',
                status: error.status
            };
        } else if (error.message) {
            // Network or parsing error
            errorData = {
                error: error.message,
                type: error.message.includes('Network') ? 'network' : 'client'
            };
        }
        
        showErrorModal(errorData);
    })
    .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        loadingText.classList.add('hidden');
    });
});

function showSuccessModal(data) {
    const modal = document.getElementById('successModal');
    const messageEl = document.getElementById('successMessage');
    const notificationTextEl = document.getElementById('notificationText');
    const notificationDetailsEl = document.getElementById('notificationDetails');
    const studentsWithoutTelegramEl = document.getElementById('studentsWithoutTelegram');
    const studentsWithoutTelegramTextEl = document.getElementById('studentsWithoutTelegramText');
    const studentsWithoutTelegramListEl = document.getElementById('studentsWithoutTelegramList');
    
    // Update success message
    messageEl.textContent = data.message || 'Attendance has been recorded successfully.';
    
    // Create detailed notification info
    const totalStudents = data.students_recorded || 0;
    const notificationsSent = data.notifications_sent || 0;
    const studentsWithTelegram = data.students_with_telegram || 0;
    const studentsWithoutTelegram = data.students_without_telegram || 0;
    const failedNotifications = data.failed_notifications || 0;
    
    let notificationHtml = '';
    
    if (notificationsSent > 0) {
        notificationHtml += `
            <div class="flex items-center justify-between">
                <span><i class="fa-solid fa-check-circle text-green-500 mr-1"></i> Sent successfully:</span>
                <span class="font-semibold">${notificationsSent}</span>
            </div>
        `;
    }
    
    if (studentsWithTelegram > 0) {
        notificationHtml += `
            <div class="flex items-center justify-between">
                <span><i class="fa-solid fa-users text-blue-500 mr-1"></i> Students with Telegram:</span>
                <span class="font-semibold">${studentsWithTelegram}</span>
            </div>
        `;
    }
    
    if (failedNotifications > 0) {
        notificationHtml += `
            <div class="flex items-center justify-between">
                <span><i class="fa-solid fa-exclamation-circle text-red-500 mr-1"></i> Failed to send:</span>
                <span class="font-semibold">${failedNotifications}</span>
            </div>
        `;
    }
    
    if (notificationHtml === '') {
        notificationHtml = '<p class="text-blue-600">No Telegram notifications sent - no students have registered.</p>';
    }
    
    notificationDetailsEl.innerHTML = notificationHtml;
    
    // Handle students without Telegram
    if (studentsWithoutTelegram > 0) {
        studentsWithoutTelegramEl.classList.remove('hidden');
        studentsWithoutTelegramTextEl.innerHTML = `
            <strong>${studentsWithoutTelegram}</strong> student${studentsWithoutTelegram > 1 ? 's' : ''} 
            ${studentsWithoutTelegram > 1 ? 'haven\'t' : 'hasn\'t'} registered for Telegram notifications yet.
        `;
        
        // Show list of students without Telegram if provided
        if (data.students_without_chat_list && data.students_without_chat_list.length > 0) {
            studentsWithoutTelegramListEl.classList.remove('hidden');
            studentsWithoutTelegramListEl.innerHTML = `
                <strong>Students without Telegram:</strong><br>
                ${data.students_without_chat_list.join(', ')}
            `;
        }
    } else {
        studentsWithoutTelegramEl.classList.add('hidden');
    }
    
    // Show modal with animation
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }, 10);
}

function showErrorAlert(message) {
    // Deprecated - now using showErrorModal
    showErrorModal({ error: message });
}

function showErrorModal(data) {
    const modal = document.getElementById('errorModal');
    const messageEl = document.getElementById('errorMessage');
    const detailsEl = document.getElementById('errorDetails');
    const detailsTextEl = document.getElementById('errorDetailsText');
    const duplicateContentEl = document.getElementById('duplicateErrorContent');
    
    // Set main error message
    messageEl.textContent = data.error || 'An error occurred while submitting attendance.';
    
    // Handle different error types
    if (data.duplicate) {
        // Show duplicate-specific content
        duplicateContentEl.classList.remove('hidden');
        detailsEl.classList.add('hidden');
    } else if (data.type === 'network') {
        // Show network error details
        detailsEl.classList.remove('hidden');
        detailsTextEl.textContent = 'Please check your internet connection and try again.';
        duplicateContentEl.classList.add('hidden');
    } else {
        // Show general error details if available
        if (data.details || data.type) {
            detailsEl.classList.remove('hidden');
            detailsTextEl.textContent = data.details || `Error type: ${data.type}`;
        } else {
            detailsEl.classList.add('hidden');
        }
        duplicateContentEl.classList.add('hidden');
    }
    
    // Show modal with animation
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }, 10);
}

function closeErrorModal() {
    const modal = document.getElementById('errorModal');
    modal.querySelector('.transform').classList.remove('scale-100');
    modal.querySelector('.transform').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function retrySubmission() {
    closeErrorModal();
    // Trigger form submission again
    document.getElementById('attendanceForm').dispatchEvent(new Event('submit'));
}

function suggestNewDate() {
    closeErrorModal();
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('date').focus();
    
    // Show a brief success message
    setTimeout(() => {
        alert('âœ… Date changed to today. You can now submit attendance.');
    }, 300);
}

function showDuplicateError(data) {
    // Deprecated - now using showErrorModal
    showErrorModal(data);
}

function goToSchedules() {
    window.location.href = '/instructor/attendance';
}

function recordAnother() {
    // Close modal and reset form
    const modal = document.getElementById('successModal');
    modal.classList.add('hidden');
    
    // Reset form
    document.getElementById('attendanceForm').reset();
    
    // Reset date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    
    // Reset all status dropdowns to "Present"
    const statusSelects = document.querySelectorAll('select[name^="status_"]');
    statusSelects.forEach(select => {
        select.value = 'Present';
    });
}

// Message Modal Functions
function openMessageModal(studentId, studentName) {
    const modal = document.getElementById('messageModal');
    document.getElementById('modalStudentName').value = studentName;
    document.getElementById('messageForm').setAttribute('data-student-id', studentId);
    
    // Show modal with animation
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }, 10);
}

function closeMessageModal() {
    const modal = document.getElementById('messageModal');
    modal.querySelector('.transform').classList.remove('scale-100');
    modal.querySelector('.transform').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function setMessageTemplate(type) {
    const messageTextarea = document.getElementById('modalMessage');
    const subjectName = document.getElementById('modalSubjectName').value;
    
    const templates = {
        dropping: `Dear Parent, your child is a candidate for dropping due to attendance issues in ${subjectName}. Immediate action is required to improve attendance.`,
        warning: `Dear Parent, your child is showing concerning attendance patterns in ${subjectName}. Please ensure regular attendance to avoid academic issues.`,
        improvement: `Dear Parent, your child needs to improve their attendance in ${subjectName}. Please discuss the importance of regular class attendance with them.`
    };
    
    messageTextarea.value = templates[type] || messageTextarea.value;
    messageTextarea.focus();
}

function sendMessage(event) {
    event.preventDefault();
    
    const studentId = event.target.getAttribute('data-student-id');
    const studentName = document.getElementById('modalStudentName').value;
    const message = document.getElementById('modalMessage').value;
    const subjectName = document.getElementById('modalSubjectName').value;
    
    const sendBtn = document.getElementById('sendMessageBtn');
    const sendText = document.getElementById('sendMessageText');
    const sendingText = document.getElementById('sendingMessageText');
    
    // Show loading state
    sendBtn.disabled = true;
    sendText.classList.add('hidden');
    sendingText.classList.remove('hidden');
    
    // Send AJAX request to backend
    fetch('/instructor/message/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            student_id: studentId,
            message: message,
            subject_name: subjectName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeMessageModal();
            showMessageSuccessModal(data);
        } else {
            closeMessageModal();
            showMessageErrorModal(data, studentName);
        }
    })
    .catch(error => {
        console.error('Message sending error:', error);
        closeMessageModal();
        showMessageErrorModal({
            error: 'Network error: ' + error.message,
            no_telegram: false
        }, studentName);
    })
    .finally(() => {
        // Reset button state
        sendBtn.disabled = false;
        sendText.classList.remove('hidden');
        sendingText.classList.add('hidden');
    });
}

function showMessageSuccessModal(data) {
    const modal = document.getElementById('messageSuccessModal');
    const messageEl = document.getElementById('messageSuccessText');
    const studentNameEl = document.getElementById('successStudentName');
    const subjectNameEl = document.getElementById('successSubjectName');
    const sentTimeEl = document.getElementById('successSentTime');
    
    // Update modal content
    messageEl.textContent = data.message || 'Your message has been sent successfully!';
    studentNameEl.textContent = data.student_name || 'Student';
    subjectNameEl.textContent = data.subject_name || 'Subject';
    sentTimeEl.textContent = data.sent_at || new Date().toLocaleString();
    
    // Show modal with animation
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }, 10);
}

function closeMessageSuccessModal() {
    const modal = document.getElementById('messageSuccessModal');
    modal.querySelector('.transform').classList.remove('scale-100');
    modal.querySelector('.transform').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function showMessageErrorModal(data, studentName) {
    const modal = document.getElementById('messageErrorModal');
    const messageEl = document.getElementById('messageErrorText');
    const studentNameEl = document.getElementById('errorStudentName');
    const errorDetailsEl = document.getElementById('messageErrorDetailsText');
    
    // Update modal content
    let errorMessage = data.error || 'There was an error sending your message.';
    
    if (data.no_telegram) {
        errorMessage = `${studentName} does not have Telegram connected. Please ask them to register first.`;
        errorDetailsEl.textContent = 'Students need to connect their Telegram account to receive messages.';
    } else {
        errorDetailsEl.textContent = data.error || 'Unknown error occurred';
    }
    
    messageEl.textContent = errorMessage;
    studentNameEl.textContent = studentName || 'Student';
    
    // Show modal with animation
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }, 10);
}

function closeMessageErrorModal() {
    const modal = document.getElementById('messageErrorModal');
    modal.querySelector('.transform').classList.remove('scale-100');
    modal.querySelector('.transform').classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}

function retryMessage() {
    closeMessageErrorModal();
    // Re-open the message modal with the same data
    const form = document.getElementById('messageForm');
    const studentId = form.getAttribute('data-student-id');
    const studentName = document.getElementById('modalStudentName').value;
    openMessageModal(studentId, studentName);
}
</script>

<!-- Live Time Script -->
<script>
function updateLiveTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('liveTime').textContent = timeString;
}
setInterval(updateLiveTime, 1000);
updateLiveTime();

document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
});
</script>

{% endblock %}
